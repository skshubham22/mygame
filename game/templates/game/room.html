{% extends 'game/base.html' %}
{% load static %}

{% block title %}Game Room - {{ room_code }}{% endblock %}

{% block content %}
<div class="container game-container">
    <div class="game-layout">
        <div class="info-section">
            <div class="header">
                <h1>Room: <span id="display-room-code">{{ room_code }}</span>
                    <button class="btn-small" onclick="copyCode()">Copy</button>
                </h1>
                <div id="status">Waiting for opponent...</div>
                <div id="connection-status" style="font-size: 0.8rem; color: #fab1a0; margin-top: 5px;">Connecting...
                </div>

                <!-- AUDIO TOGGLE -->
                <div class="audio-controls" style="margin-top: 15px;">
                    <button id="music-toggle" onclick="toggleMusic()" class="btn-small">üéµ ON</button>
                    <button id="sfx-toggle" onclick="toggleSFX()" class="btn-small">üîä ON</button>
                </div>
            </div>

            <div class="players-list" id="players-list">
                <!-- Players will be listed here -->
            </div>

            <div class="controls">
                <button onclick="window.location.href='/'" class="btn btn-secondary">Leave Room</button>
            </div>

            <!-- CHAT SECTION -->
            <div class="chat-section">
                <!-- Sidebar Chat Messages removed (Used Board Overlay) -->
                <div class="chat-input-area">
                    <button id="sticker-btn" onclick="toggleStickerPicker()" class="btn-small"
                        title="Stickers">‚ò∫</button>
                    <input type="text" id="chat-input" placeholder="Type..." onkeypress="handleChatKey(event)">
                    <button onclick="sendChat()" class="btn-small">‚û§</button>
                </div>

                <!-- Sticker Picker Overlay -->
                <div id="sticker-picker" class="sticker-picker hidden">
                    <input type="text" id="sticker-search" placeholder="Search stickers..." onkeyup="filterStickers()">
                    <div id="sticker-grid" class="sticker-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="reaction-bar">
                    <button onclick="sendReaction('üëç')" class="reaction-btn">üëç</button>
                    <button onclick="sendReaction('üòÇ')" class="reaction-btn">üòÇ</button>
                    <button onclick="sendReaction('üò°')" class="reaction-btn">üò°</button>
                    <button onclick="sendReaction('üòÆ')" class="reaction-btn">üòÆ</button>
                    <button onclick="sendReaction('üéâ')" class="reaction-btn">üéâ</button>
                </div>
            </div>
        </div>

        <!-- SHARED DICE (In Layout Gap) -->
        <!-- SHARED DICE (In Layout Gap) -->
        {% if game_type != 'TIC_TAC_TOE' %}
        <div id="dice-wrapper" class="dice-wrapper">
            <div id="shared-dice" class="dice-btn" onclick="rollDice()">
                <div class="dice-box">
                    <span class="dice-placeholder">üé≤</span>
                </div>
            </div>
            <div id="dice-label" class="dice-label">ROLL DICE</div>
        </div>
        {% endif %}

        <div class="board-section" style="position: relative;">
            <div id="game-board" class="board {{ game_type|lower }}">
                <!-- Board cells will be generated by JS -->
            </div>

            <!-- Board Chat Display (For All Games) -->
            <div id="board-chat-display" class="board-chat-display">
                <!-- Chat messages will appear here -->
            </div>
        </div>
    </div>
</div>

<!-- AUDIO ELEMENTS -->
<audio id="bgm" loop src="https://assets.mixkit.co/music/preview/mixkit-game-level-music-689.mp3"></audio>
<audio id="sfx-dice" src="https://assets.mixkit.co/sfx/preview/mixkit-dice-roll-on-a-wooden-table-2720.mp3"></audio>
<audio id="sfx-move" src="https://assets.mixkit.co/sfx/preview/mixkit-cartoon-toy-whistle-short-643.mp3"></audio>
<audio id="sfx-snake" src="https://assets.mixkit.co/sfx/preview/mixkit-snake-hissing-703.mp3"></audio>
<audio id="sfx-ladder" src="https://assets.mixkit.co/sfx/preview/mixkit-shimmering-objects-appearing-3054.mp3"></audio>
<audio id="sfx-win" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>

<!-- CONFETTI CONTAINER -->
<div id="confetti-container"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden;">
</div>

<!-- Result Modal -->
<div id="result-modal" class="modal">
    <div class="modal-content">
        <h2 id="result-title">Game Over!</h2>
        <div id="result-message">Winner: Player Name</div>
        <button onclick="resetGame()" class="btn btn-primary" style="margin-top: 20px;">Play Again</button>
    </div>
</div>
</div>

{{ room_code|json_script:"room-code" }}
{{ game_type|json_script:"game-type" }}
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'game/game.js' %}?v=2.4"></script>
<script>
    function copyCode() {
        const code = document.getElementById('display-room-code').innerText;
        navigator.clipboard.writeText(code).then(() => {
            alert('Room code copied: ' + code);
        });
    }
</script>
{% endblock %}