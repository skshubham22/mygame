{% extends 'game/base.html' %}
{% load static %}

{% block title %}Game Room - {{ room_code }}{% endblock %}

{% block content %}
<div class="container game-container">
    <div class="game-layout">
        <div class="info-section">
            <div class="header">
                <h1>Room: <span id="display-room-code">{{ room_code }}</span>
                    <button class="btn-small" onclick="copyCode()">Copy</button>
                </h1>
                <div id="status">Waiting for opponent...</div>
                <div id="connection-status" style="font-size: 0.8rem; color: #fab1a0; margin-top: 5px;">Connecting...
                </div>
            </div>

            <div class="players-list" id="players-list">
                <!-- Players will be listed here -->
            </div>

            <div class="controls">
                <button onclick="window.location.href='/'" class="btn btn-secondary">Leave Room</button>
            </div>

            <!-- CHAT SECTION -->
            <div class="chat-section">
                {% if game_type != 'TIC_TAC_TOE' %}
                <div id="chat-messages" class="chat-messages">
                    <div class="chat-msg system">Welcome to {{ game_type|title|default:"Game" }} Chat!</div>
                </div>
                {% endif %}
                <div class="chat-input-area">
                    <button id="sticker-btn" onclick="toggleStickerPicker()" class="btn-small"
                        title="Stickers">‚ò∫</button>
                    <input type="text" id="chat-input" placeholder="Type..." onkeypress="handleChatKey(event)">
                    <button onclick="sendChat()" class="btn-small">‚û§</button>
                </div>

                <!-- Sticker Picker Overlay -->
                <div id="sticker-picker" class="sticker-picker hidden">
                    <input type="text" id="sticker-search" placeholder="Search stickers..." onkeyup="filterStickers()">
                    <div id="sticker-grid" class="sticker-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="reaction-bar">
                    <button onclick="sendReaction('üëç')" class="reaction-btn">üëç</button>
                    <button onclick="sendReaction('üòÇ')" class="reaction-btn">üòÇ</button>
                    <button onclick="sendReaction('üò°')" class="reaction-btn">üò°</button>
                    <button onclick="sendReaction('üòÆ')" class="reaction-btn">üòÆ</button>
                    <button onclick="sendReaction('üéâ')" class="reaction-btn">üéâ</button>
                </div>
            </div>
        </div>

        <!-- SHARED DICE (In Layout Gap) -->
        <!-- SHARED DICE (In Layout Gap) -->
        {% if game_type != 'TIC_TAC_TOE' %}
        <div id="shared-dice" class="dice-container shared">
            <div class="dice-box"></div>
        </div>
        {% endif %}

        <div class="board-section" style="position: relative;">
            <div id="game-board" class="board {{ game_type|lower }}">
                <!-- Board cells will be generated by JS -->
            </div>

            {% if game_type == 'TIC_TAC_TOE' %}
            <div id="board-chat-display" class="board-chat-display">
                <!-- Chat messages will appear here -->
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Result Modal -->
<div id="result-modal" class="modal">
    <div class="modal-content">
        <h2 id="result-title">Game Over!</h2>
        <div id="result-message">Winner: Player Name</div>
        <button onclick="resetGame()" class="btn btn-primary" style="margin-top: 20px;">Play Again</button>
    </div>
</div>
</div>

{{ room_code|json_script:"room-code" }}
{{ game_type|json_script:"game-type" }}
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'game/game.js' %}?v=2.0"></script>
<script>
    function copyCode() {
        const code = document.getElementById('display-room-code').innerText;
        navigator.clipboard.writeText(code).then(() => {
            alert('Room code copied: ' + code);
        });
    }
</script>
{% endblock %}